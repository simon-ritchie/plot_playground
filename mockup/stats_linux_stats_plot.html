<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v4.js"></script>
        <style>
            #test-svg {
                background-color: #333333;
            }

            #test-svg .font {
                font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", YuGothic, "ヒラギノ角ゴ ProN W3", Hiragino Kaku Gothic ProN, Arial, "メイリオ", Meiryo, sans-serif;
            }

            #test-svg .outer-border-rect {
                fill: none;
                stroke: #999999;
                stroke-width: 1px;
            }

            #test-svg .line {
                fill: none;
                stroke: #cccccc;
                stroke-width: 2.5;
            }

            #test-svg .axis text {
                fill: #999999;
                font-size: 14px;
            }

            #test-svg .axis line,
            #test-svg .axis path {
                fill: none;
                stroke: #999999;
                shape-rendering: crispEdges;
            }
        </style>
    </head>
    <body>
        <script>
            const SVG_ID = "test-svg";
            const SVG_WIDTH = 700;
            const BASIC_MARGIN = 20;
            const PLOT_UNIT_HEIGHT = 200;
            const SVG_TOTAL_HEIGHT = PLOT_UNIT_HEIGHT * 4 + BASIC_MARGIN * 5;
            const PLOT_X = 1 + BASIC_MARGIN;
            const GPU_NUM = 2;
            const LOG_FILE_PATH = "./stats_linux_stats_plot_log.csv";
            const COLUMN_NAME_MEMORY_USAGE = "memory usage (MB)";
            const COLUMN_NAME_DISK_USAGE = "disk usage (GB)";
            const INTERVAL_SECONDS = 1;
            const AXIS_TICKS = 5;

            /**
             * Gets the column name of memory usage of the GPU.
             *
             * @param {int} gpuIndex: Index of target GPU (Starting
             * from zero).
             *
             * @return {String} GPU column name.
             */
            function getGPUColumnName(gpuIndex) {
                return "gpu(" + gpuIndex + ") memory usage (MB)";
            }

            var svg = d3.select("body").append('svg')
                .attr("width", SVG_WIDTH)
                .attr("height", SVG_TOTAL_HEIGHT)
                .attr("id", SVG_ID);

            const MEMORY_USAGE_PLOT_Y = 1 + BASIC_MARGIN;
            var memoryUsagePlotBorderRect = svg.append("rect")
                .attr("width", SVG_WIDTH - 2 - BASIC_MARGIN * 2)
                .attr("height", PLOT_UNIT_HEIGHT - 2)
                .classed("outer-border-rect", true)
                .attr("x", PLOT_X)
                .attr("y", 1 + BASIC_MARGIN);

            const DISK_USAGE_PLOT_Y = PLOT_UNIT_HEIGHT + BASIC_MARGIN * 2 + 1;
            var diskUsagePlotBorderRect = svg.append("rect")
                .attr("width", SVG_WIDTH - 2 - BASIC_MARGIN * 2)
                .attr("height", PLOT_UNIT_HEIGHT - 2)
                .classed("outer-border-rect", true)
                .attr("x", PLOT_X)
                .attr("y", DISK_USAGE_PLOT_Y);

            var gpuMemoryUsagePlotYList = [];
            for (var i = 0; i < GPU_NUM; i++) {
                var gpuMemoryUsagePlotY = PLOT_UNIT_HEIGHT * (2 + i) + BASIC_MARGIN * (3 + i) + 1;
                gpuMemoryUsagePlotYList.push(gpuMemoryUsagePlotY);
                svg.append("rect")
                    .attr("width", SVG_WIDTH - 2 - BASIC_MARGIN * 2)
                    .attr("height", PLOT_UNIT_HEIGHT - 2)
                    .classed("outer-border-rect", true)
                    .attr("x", PLOT_X)
                    .attr("y", gpuMemoryUsagePlotY);
            }

            var rowConverter = function(d) {
                var rowDict = {
                    memoryUsage: parseInt(d[COLUMN_NAME_MEMORY_USAGE]),
                    diskUsage: parseFloat(d[COLUMN_NAME_DISK_USAGE])
                };
                for (var i = 0; i < GPU_NUM; i++) {
                    var gpuColumnName = getGPUColumnName(gpuIndex=i);
                    rowDict["gpuMemoryUsage" + i] = parseInt(
                        d[gpuColumnName]);
                }
                return rowDict;
            }

            var memoryUsageYScale = d3.scaleLinear()
                .range([
                    MEMORY_USAGE_PLOT_Y + PLOT_UNIT_HEIGHT - 1 - BASIC_MARGIN,
                    MEMORY_USAGE_PLOT_Y + 1 + BASIC_MARGIN]);
            var memoryUsageAxis = d3.axisLeft()
                .ticks(AXIS_TICKS);
            var memoryUsageAxisGroup = svg.append("g")
                .classed("axis font", true);

            var diskUsageYScale = d3.scaleLinear()
                .range([
                    DISK_USAGE_PLOT_Y + PLOT_UNIT_HEIGHT - 1 - BASIC_MARGIN,
                    DISK_USAGE_PLOT_Y + 1 + BASIC_MARGIN]);
            var diskUsageAxis = d3.axisLeft()
                .ticks(AXIS_TICKS);
            var diskUsageAxisGroup = svg.append("g")
                .classed("axis font", true);

            var gpuMemoryUsageYScaleList = [];
            var gpuMemoryUsageAxisList = [];
            var gpuMemoryUsageAxisGroupList = [];
            for (var i = 0; i < GPU_NUM; i++) {
                gpuMemoryUsageYScaleList.push(
                    d3.scaleLinear()
                        .range([
                            gpuMemoryUsagePlotYList[i] + PLOT_UNIT_HEIGHT - 1 - BASIC_MARGIN,
                            gpuMemoryUsagePlotYList[i] + 1 + BASIC_MARGIN
                        ])
                );
                gpuMemoryUsageAxisList.push(
                    d3.axisLeft()
                        .ticks(AXIS_TICKS)
                );
                gpuMemoryUsageAxisGroupList.push(
                    svg.append("g")
                        .classed("axis font", true)
                );
            }

            /**
             * Read the CSV and update the value of the plot.
             */
            function update_plot_value() {
                d3.csv(LOG_FILE_PATH, rowConverter, function(dataset) {
                    var memoryUsageMax = d3.max(dataset, function(d) {
                        return d.memoryUsage;
                    });
                    memoryUsageYScale.domain([0, memoryUsageMax]);
                    memoryUsageAxis.scale(memoryUsageYScale);
                    memoryUsageAxisGroup.call(memoryUsageAxis);
                    var memoryUsageAxisBBox = memoryUsageAxisGroup.node()
                        .getBBox();
                    memoryUsageAxisGroup
                        .attr("transform", "translate(" + (memoryUsageAxisBBox.width + BASIC_MARGIN * 2 + 1) + ", 0)");

                    var diskUsageMax = d3.max(dataset, function(d) {
                        return d.diskUsage;
                    });
                    diskUsageYScale.domain([0, diskUsageMax]);
                    diskUsageAxis.scale(diskUsageYScale);
                    diskUsageAxisGroup.call(diskUsageAxis);
                    var diskUsageAxisBBox = diskUsageAxisGroup.node()
                        .getBBox();
                    diskUsageAxisGroup
                        .attr("transform", "translate(" + (diskUsageAxisBBox.width + BASIC_MARGIN * 2 + 1) + ", 0)");

                    var gpuMemoryUsageAxisBBoxList = [];
                    for (var i = 0; i < GPU_NUM; i++) {
                        var gpuMemoryUsageMax = d3.max(dataset, function(d) {
                            return d["gpuMemoryUsage" + i];
                        });
                        gpuMemoryUsageYScaleList[i].domain(
                            [0, gpuMemoryUsageMax]);
                        gpuMemoryUsageAxisList[i].scale(
                            gpuMemoryUsageYScaleList[i]);
                        gpuMemoryUsageAxisGroupList[i].call(
                            gpuMemoryUsageAxisList[i]);
                        var gpuMemoryUsageAxisBBox = gpuMemoryUsageAxisGroupList[i].node()
                            .getBBox();
                        gpuMemoryUsageAxisBBoxList.push(gpuMemoryUsageAxisBBox);
                        gpuMemoryUsageAxisGroupList[i].
                            attr("transform", "translate(" + (gpuMemoryUsageAxisBBox.width + BASIC_MARGIN * 2 + 1) + ", 0)");
                    }
                });
            }

            update_plot_value();
            setInterval(
                update_plot_value,
                INTERVAL_SECONDS * 1000);

        </script>
    </body>
</html>
